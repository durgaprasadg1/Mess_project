
<div
  id="loader"
  class="d-flex justify-content-center align-items-center"
  style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 9999;
    opacity: 1;
  "
>
  <div class="spinner-grow text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
<%- layout("/layouts/boilerplate") %>

<div class="container my-5">
  <h2 class="mb-4 text-center fw-bold text-primary">Your Orders</h2>
  <div class="container my-5">
  
      <form method="post" action="/mess/<%= currentUser.mess[0] %>/orders/delete?_method=DELETE"
            onsubmit="return confirm('Are you sure you want to delete your completed orders?')">
        <button type="submit" 
                class="btn btn-danger btn-sm fw-semibold shadow-sm px-3 py-2"
                style="border-radius: 25px; transition: all 0.3s;">
          <i class="fa-solid fa-trash me-2"></i> Delete Orders
        </button>
      </form>
    </div>

  <% if (orders && orders.length > 0) { %>
  <div class="table-responsive shadow-sm rounded">
    <table class="table table-striped align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th scope="col">Sr. No</th>
          <th scope="col">Mess</th>
          <th scope="col">Consumer</th>
          <th scope="col">Total Plates</th>
          <th scope="col">Total Price</th>
          <th scope="col">Placed On</th>
          <th scope="col">Taken</th>
          <th scope="col">Done</th>
        </tr>
      </thead>
      <tbody class="text-center">
        <% orders.forEach((order, index) => { %>
        <tr>
          <th scope="row"><%= index + 1 %></th>
          <td><%= order.mess ? order.mess.name : "N/A" %></td>
          <td><%= order.consumer ? order.consumer.username : "N/A" %></td>
          <td><%= order.noOfPlate %></td>
          <td>â‚¹<%= order.totalPrice * order.noOfPlate %></td>

          <td>
            <%= new Date(order.createdAt).toLocaleString("en-IN", {
              weekday: "short",
              day: "2-digit",
              month: "short",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: true,
              timeZone: "Asia/Kolkata"
            }) %>

          </td>
          <td>
            <% if (order.isTaken) { %>
              <button class="btn btn-success btn-sm d-flex align-items-center justify-content-center px-3 py-1 fw-semibold shadow-sm"
                style="border-radius: 25px;" disabled>
                <i class="fa-solid fa-check"></i>
              </button>
            <% } else { %>
              <form method="POST" action="/orders/<%= order._id %>/taken">
                <button type="submit"
                  class="btn btn-danger btn-sm d-flex align-items-center justify-content-center px-3 py-1 fw-semibold shadow-sm"
                  style="border-radius: 25px; transition: all 0.3s;">
                  <i class="fa-solid fa-clock"></i>
                </button>
              </form>
            <% } %>
          </td>

          <td>
            <% if (order.done ) { %>
              <button class="btn btn-success btn-sm d-flex align-items-center justify-content-center px-3 py-1 fw-semibold shadow-sm"
                style="border-radius: 25px;" disabled>
                <i class="fa-solid fa-check"></i>
              </button>
            <% } else { %>
              <% if (order.isTaken ) { %>
                <form method="POST" action="/orders/<%= order._id%>/done">
                  <button type="submit"
                    class="btn btn-danger btn-sm d-flex align-items-center justify-content-center px-3 py-1 fw-semibold shadow-sm"
                    style="border-radius: 25px; transition: all 0.3s;">
                    <i class="fa-solid fa-clock"></i>
                  </button>
                </form>
             <% } %>
            <% } %>
          </td>
          

        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } else { %>
  <div class="alert alert-info text-center">No orders found.</div>
  <% } %>
</div>

<script>

   window.addEventListener("load", function () {
    const loader = document.getElementById("loader");
    loader.style.transition = "opacity 0.5s ease";
    loader.style.opacity = "0";
    loader.style.zIndex = -99;
    setTimeout(() => loader.style.display = "none", 500);
  });

  document.querySelectorAll(".doneForm").forEach(form => {
    const btn = form.querySelector(".orderBtn");

    btn.addEventListener("click", (e) => {
      e.preventDefault(); 

      btn.classList.remove("btn-danger");
      btn.classList.add("btn-success");
      btn.innerHTML = `<i class="fa-solid fa-check me-2"></i>`;
      btn.disabled = true;

      form.submit();
    });
  });
</script>

